<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم العقارات</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    #loginForm, #adminPanel { display: none; }
    .property-card { border: 1px solid #ccc; margin: 10px; padding: 10px; border-radius: 5px; }
    .property-card button { margin: 5px; }
    #setPasswordForm { display: block; }
    .error { color: red; }
  </style>
</head>
<body>

  <!-- صفحة تعيين كلمة المرور -->
  <div id="setPasswordForm">
    <h2>تعيين كلمة مرور المشرف</h2>
    <input type="password" id="passwordInput" placeholder="أدخل كلمة المرور" required><br>
    <input type="password" id="confirmPasswordInput" placeholder="تأكيد كلمة المرور" required><br>
    <button onclick="setPassword()">تعيين كلمة المرور</button>
    <p class="error" id="setPasswordError"></p>
  </div>

  <!-- صفحة تسجيل الدخول -->
  <div id="loginForm">
    <h2>تسجيل الدخول</h2>
    <input type="password" id="loginPasswordInput" placeholder="أدخل كلمة المرور" required><br>
    <button onclick="login()">تسجيل الدخول</button>
    <p class="error" id="loginErrorMessage"></p>
  </div>

  <!-- لوحة تحكم المشرف -->
  <div id="adminPanel">
    <h2>لوحة تحكم العقارات</h2>
    <h3>إضافة عقار جديد</h3>
    <input type="text" id="type" placeholder="نوع العقار" required><br>
    <input type="text" id="district" placeholder="الحي" required><br>
    <input type="number" id="price" placeholder="السعر" required><br>
    <input type="text" id="code" placeholder="كود العقار" required><br>
    <textarea id="desc" placeholder="وصف العقار" required></textarea><br>
    <input type="text" id="image" placeholder="رابط الصورة" required><br>
    <button onclick="addProperty()">إضافة عقار</button>
    <p class="error" id="addPropertyError"></p>

    <h3>عرض العقارات</h3>
    <select id="cityFilter">
      <option value="">اختر المدينة</option>
      <option value="مدينة 1">مدينة 1</option>
      <option value="مدينة 2">مدينة 2</option>
    </select>
    <select id="sortFilter">
      <option value="latest">ترتيب حسب الأحدث</option>
      <option value="priceHigh">ترتيب حسب السعر (أعلى إلى أدنى)</option>
      <option value="priceLow">ترتيب حسب السعر (أدنى إلى أعلى)</option>
      <option value="oldest">ترتيب حسب الأقدم</option>
    </select>
    <div id="propertyList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    function setPassword() {
      const password = document.getElementById("passwordInput").value;
      const confirmPassword = document.getElementById("confirmPasswordInput").value;

      if (password === confirmPassword) {
        hashPassword(password).then(hash => {
          // Save the hashed password in Firebase database
          database.ref("adminPassword").set(hash).then(() => {
            document.getElementById("setPasswordForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
          }).catch(error => {
            document.getElementById("setPasswordError").textContent = "حدث خطأ أثناء حفظ كلمة المرور.";
          });
        });
      } else {
        document.getElementById("setPasswordError").textContent = "كلمات المرور غير متطابقة.";
      }
    }

    function login() {
      const password = document.getElementById("loginPasswordInput").value;
      database.ref("adminPassword").once("value").then(snapshot => {
        const savedPasswordHash = snapshot.val();
        hashPassword(password).then(hash => {
          if (savedPasswordHash === hash) {
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("adminPanel").style.display = "block";
            getProperties(); // Load properties after login
          } else {
            document.getElementById("loginErrorMessage").textContent = "كلمة المرور غير صحيحة.";
          }
        });
      });
    }

    function addProperty() {
      const type = document.getElementById("type").value;
      const district = document.getElementById("district").value;
      const price = document.getElementById("price").value;
      const code = document.getElementById("code").value;
      const desc = document.getElementById("desc").value;
      const image = document.getElementById("image").value;

      if (type && district && price && code && desc && image) {
        const property = {
          type,
          district,
          price,
          code,
          desc,
          image,
          timestamp: Date.now()
        };

        database.ref("properties").push(property).then(() => {
          alert("تم إضافة العقار بنجاح.");
          clearAddPropertyForm();
          getProperties(); // Refresh the property list
        }).catch(error => {
          document.getElementById("addPropertyError").textContent = "حدث خطأ أثناء إضافة العقار.";
        });
      } else {
        document.getElementById("addPropertyError").textContent = "يرجى تعبئة جميع الحقول.";
      }
    }

    function clearAddPropertyForm() {
      document.getElementById("type").value = "";
      document.getElementById("district").value = "";
      document.getElementById("price").value = "";
      document.getElementById("code").value = "";
      document.getElementById("desc").value = "";
      document.getElementById("image").value = "";
    }

    function renderProperties(properties) {
      const propertyList = document.getElementById("propertyList");
      propertyList.innerHTML = '';

      properties.forEach(property => {
        const propertyCard = document.createElement('div');
        propertyCard.className = 'property-card';
        propertyCard.innerHTML = `
          <div>
            <strong>${property.type}</strong> - ${property.district} <br>
            السعر: ${property.price} <br>
            <p>${property.desc}</p>
          </div>
          <div>
            <button onclick="editProperty('${property.code}')">تعديل</button>
            <button onclick="saveChanges('${property.code}')">حفظ التغييرات</button>
            <button onclick="deleteProperty('${property.code}')">حذف</button>
            <button onclick="shareProperty('${property.code}')">مشاركة</button>
          </div>
        `;
        propertyList.appendChild(propertyCard);
      });
    }

    function getProperties() {
      database.ref("properties").once('value').then(snapshot => {
        const properties = [];
        snapshot.forEach(childSnapshot => {
          properties.push(childSnapshot.val());
        });

        // Apply filters
        const city = document.getElementById('cityFilter').value;
        const sortBy = document.getElementById('sortFilter').value;

        // Filter by city
        let filteredProperties = properties.filter(property => {
          if (city && property.district !== city) {
            return false;
          }
          return true;
        });

        // Sort properties
        if (sortBy === 'latest') {
          filteredProperties.sort((a, b) => b.timestamp - a.timestamp);
        } else if (sortBy === 'priceHigh') {
          filteredProperties.sort((a, b) => b.price - a.price);
        } else if (sortBy === 'priceLow') {
          filteredProperties.sort((a, b) => a.price - b.price);
        } else if (sortBy === 'oldest') {
          filteredProperties.sort((a, b) => a.timestamp - b.timestamp);
        }

        renderProperties(filteredProperties);
      });
    }

    function editProperty(code) {
      alert(`تعديل العقار برقم الكود: ${code}`);
    }

    function saveChanges(code) {
      alert(`حفظ التغييرات للعقار برقم الكود: ${code}`);
    }

    function deleteProperty(code) {
      if (confirm('هل أنت متأكد من أنك تريد حذف هذا العقار؟')) {
        database.ref("properties").orderByChild('code').equalTo(code).once('value', snapshot => {
          snapshot.forEach(childSnapshot => {
            childSnapshot.ref.remove();
          });
        });
        alert("تم حذف العقار بنجاح.");
        getProperties();
      }
    }

    function shareProperty(code) {
      alert(`مشاركة العقار برقم الكود: ${code}`);
    }

    window.onload = function() {
      getProperties();

      document.getElementById('cityFilter').addEventListener('change', getProperties);
      document.getElementById('sortFilter').addEventListener('change', getProperties);
    }
  </script>

</body>
</html>
