<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
</head>
<body>
  <h2>لوحة التحكم</h2>

  <div id="setPasswordForm">
    <h3>تعيين كلمة مرور المدير</h3>
    <p>
      كلمة المرور يجب أن تحتوي على:
      <ul>
        <li>8 أحرف على الأقل</li>
        <li>حرف كبير واحد على الأقل (مثل A-Z)</li>
        <li>رقم واحد على الأقل (مثل 0-9)</li>
        <li>رمز خاص واحد على الأقل (مثل !@#$%^&*)</li>
      </ul>
    </p>
    <input type="password" id="passwordInput" placeholder="أدخل كلمة المرور" required>
    <input type="password" id="confirmPasswordInput" placeholder="أعد كتابة كلمة المرور" required>
    <button onclick="setPassword()">تعيين كلمة المرور</button>
    <p id="setPasswordError" style="color:red;"></p>
  </div>

  <div id="loginForm" style="display:none;">
    <h3>تسجيل الدخول</h3>
    <input type="password" id="loginPasswordInput" placeholder="أدخل كلمة المرور" required>
    <button onclick="login()">دخول</button>
    <p id="loginErrorMessage" style="color:red;"></p>
  </div>

  <div id="adminPanel" style="display:none;">
    <h3>مرحبًا بك في لوحة التحكم!</h3>
    <!-- المحتوى الخاص بلوحة التحكم -->
  </div>

  <script>
    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
      authDomain: "hamsa-6009e.firebaseapp.com",
      databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
      projectId: "hamsa-6009e",
      storageBucket: "hamsa-6009e.appspot.com",
      messagingSenderId: "998163671039",
      appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // التحقق من الشروط
    function isPasswordStrong(password) {
      const minLength = /.{8,}/;
      const hasUpper = /[A-Z]/;
      const hasNumber = /[0-9]/;
      const hasSpecial = /[!@#$%^&*]/;
      return minLength.test(password) && hasUpper.test(password) && hasNumber.test(password) && hasSpecial.test(password);
    }

    function setPassword() {
      const password = document.getElementById("passwordInput").value;
      const confirmPassword = document.getElementById("confirmPasswordInput").value;
      const errorEl = document.getElementById("setPasswordError");

      if (!password || password !== confirmPassword) {
        errorEl.textContent = "كلمتا المرور غير متطابقتين أو فارغتين.";
        return;
      }

      if (!isPasswordStrong(password)) {
        errorEl.textContent = "كلمة المرور لا تحقق الشروط المطلوبة.";
        return;
      }

      const hash = bcrypt.hashSync(password, 10);
      firebase.database().ref("adminPassword").set(hash)
        .then(() => {
          document.getElementById("setPasswordForm").style.display = "none";
          document.getElementById("loginForm").style.display = "block";
        })
        .catch((error) => {
          console.error("خطأ أثناء الحفظ:", error);
        });
    }

    function login() {
      const enteredPassword = document.getElementById("loginPasswordInput").value;
      firebase.database().ref("adminPassword").get()
        .then((snapshot) => {
          if (snapshot.exists()) {
            const hash = snapshot.val();
            if (bcrypt.compareSync(enteredPassword, hash)) {
              document.getElementById("loginForm").style.display = "none";
              document.getElementById("adminPanel").style.display = "block";
            } else {
              document.getElementById("loginErrorMessage").textContent = "كلمة المرور غير صحيحة.";
            }
          } else {
            document.getElementById("loginErrorMessage").textContent = "لا توجد كلمة مرور مسجلة.";
          }
        })
        .catch((error) => {
          console.error("خطأ في تسجيل الدخول:", error);
        });
    }

    function checkPasswordSet() {
      firebase.database().ref("adminPassword").get()
        .then((snapshot) => {
          if (snapshot.exists()) {
            document.getElementById("setPasswordForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
          } else {
            document.getElementById("setPasswordForm").style.display = "block";
            document.getElementById("loginForm").style.display = "none";
          }
        });
    }

    window.onload = checkPasswordSet;
  </script>
</body>
</html>
