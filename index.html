<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
</head>
<body>
  <h2>Control Panel</h2>

  <div id="setPasswordForm">
    <h3>Set Admin Password</h3>
    <input type="password" id="passwordInput" placeholder="Enter password" required>
    <input type="password" id="confirmPasswordInput" placeholder="Confirm password" required>
    <button onclick="setPassword()">Set Password</button>
    <p id="setPasswordError" style="color:red;"></p>
  </div>

  <div id="loginForm" style="display:none;">
    <h3>Login</h3>
    <input type="password" id="loginPasswordInput" placeholder="Enter password" required>
    <button onclick="login()">Login</button>
    <p id="loginErrorMessage" style="color:red;"></p>
  </div>

  <div id="adminPanel" style="display:none;">
    <h3>Welcome to the Admin Panel!</h3>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
      authDomain: "hamsa-6009e.firebaseapp.com",
      databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
      projectId: "hamsa-6009e",
      storageBucket: "hamsa-6009e.appspot.com",
      messagingSenderId: "998163671039",
      appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function setPassword() {
      const password = document.getElementById("passwordInput").value;
      const confirmPassword = document.getElementById("confirmPasswordInput").value;
      const errorElement = document.getElementById("setPasswordError");

      errorElement.textContent = "";

      if (!password || !confirmPassword || password !== confirmPassword) {
        errorElement.textContent = "Passwords do not match or are empty.";
        return;
      }

      // استخدم bcrypt بأسلوب غير متزامن
      bcrypt.hash(password, 10, function(err, hash) {
        if (err) {
          console.error("Hashing error:", err);
          errorElement.textContent = "Hashing failed.";
          return;
        }

        // حفظ التشفير في Realtime Database
        database.ref("adminPassword").set(hash)
          .then(() => {
            document.getElementById("setPasswordForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
          })
          .catch((error) => {
            console.error("Error saving password:", error);
            errorElement.textContent = "Error saving password.";
          });
      });
    }

    function login() {
      const enteredPassword = document.getElementById("loginPasswordInput").value;
      const errorElement = document.getElementById("loginErrorMessage");

      errorElement.textContent = "";

      database.ref("adminPassword").get()
        .then((snapshot) => {
          if (snapshot.exists()) {
            const storedHash = snapshot.val();

            bcrypt.compare(enteredPassword, storedHash, function(err, result) {
              if (err) {
                console.error("Compare error:", err);
                errorElement.textContent = "Comparison failed.";
                return;
              }

              if (result) {
                document.getElementById("loginForm").style.display = "none";
                document.getElementById("adminPanel").style.display = "block";
              } else {
                errorElement.textContent = "Incorrect password.";
              }
            });
          } else {
            errorElement.textContent = "No password found.";
          }
        })
        .catch((error) => {
          console.error("Login error:", error);
        });
    }

    function checkPasswordSet() {
      database.ref("adminPassword").get()
        .then((snapshot) => {
          if (snapshot.exists()) {
            document.getElementById("setPasswordForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
          } else {
            document.getElementById("setPasswordForm").style.display = "block";
            document.getElementById("loginForm").style.display = "none";
          }
        })
        .catch((error) => {
          console.error("Error checking password:", error);
        });
    }

    window.onload = checkPasswordSet;
  </script>
</body>
</html>
